id: sendmail-user-execution-prevention

info:
  name: Sendmail Execution Restriction for General Users
  author: songyaeji
  severity: medium
  description: >
    This template checks whether general users are restricted from executing Sendmail using the 'q' option,
    and whether the Postfix binary is restricted to root or appropriate group members.
    Lack of restriction could allow unauthorized users to manipulate the mail queue or disrupt mail delivery.
  reference:
    - https://isms.kisa.or.kr
    - Cloud Vulnerability Assessment Guide(2024) by KISA
  tags: linux,sendmail,postfix,misconfiguration,local
  metadata:
    verified: true
    os: linux
    max-request: 1
  classification:
    cvss-metrics: CVSS:3.1/AV:L/AC:L/PR:L/UI:N/S:U/C:L/I:L/A:N
    cvss-score: 5.5
    cwe-id: CWE-732

self-contained: true

code:
  - engine:
      - bash
    source: |
      VULN=0

      if ! grep -qi 'restrictqrun' /etc/mail/sendmail.cf 2>/dev/null; then
        echo "[VULNERABLE] sendmail.cf missing 'restrictqrun'"
        VULN=1
      fi

      if [ -x /usr/sbin/postfix ]; then
        PERM="$(stat -c '%A' /usr/sbin/postfix 2>/dev/null || echo '')"
        if [ "$PERM" != "-rwxr-x---" ]; then
          echo "[VULNERABLE] /usr/sbin/postfix permission is '$PERM' (expected -rwxr-x---)"
          VULN=1
        fi
      else
        :
      fi

      if getent group postfix >/dev/null 2>&1; then
        MEMBERS="$(getent group postfix | awk -F ':' '{print $4}')"
        echo "$MEMBERS" | grep -qw root || { echo "[VULNERABLE] 'root' not in 'postfix' group"; VULN=1; }
      else
        :
      fi

      if [ "$VULN" -eq 0 ]; then
        echo "[SAFE] sendmail/postfix execution restrictions look OK"
      fi
    matchers:
      - type: word
        words:
          - "[VULNERABLE]"