id: share-permission-check

info:
  name: Share Permissions and User Group Settings Check
  author: nukunga[SungHyunJeon]
  severity: medium
  description: |
    Verify that non-default shared directories do not include the "Everyone" group in their share permissions.
    Default shares (C$, D$, Admin$, IPC$) are exempt from this check.
  impact: |
    Inclusion of "Everyone" in share permissions for non-default shares may allow unauthorized or anonymous access to shared resources.
  remediation: |
    Remove the "Everyone" group from share permissions for any non-default shared folder.
  tags: windows, share-permissions, security

self-contained: true

code:
  - pre-condition: |
      IsWindows();
    engine:
      - powershell
      - powershell.exe
    args:
      - -ExecutionPolicy
      - Bypass
    pattern: "*.ps1"
    source: |
      # Retrieve all shared folders using 'net share'
      $netShares = net share | Out-String
      $lines = $netShares -split "`n"
      $shareNames = @()
      $startParsing = $false
      
      foreach ($line in $lines) {
          # Detect start of share listing by a separator line
          if ($line -match "^-+") {
              $startParsing = $true
              continue
          }
          # Parse share names once listing has started, ignoring empty lines and footer text
          if ($startParsing -and $line.Trim() -ne "" -and $line -notmatch "The command completed successfully") {
              $tokens = $line.Trim() -split "\s+"
              if ($tokens.Count -gt 0) {
                  $shareNames += $tokens[0]
              }
          }
      }
      
      # Define default shares to be exempted
      $defaultShares = @("C$", "D$", "Admin$", "IPC$")
      $vulnerableFound = $false
      
      # Check each non-default share for the presence of 'Everyone' in its permissions
      foreach ($share in $shareNames) {
          if ($defaultShares -contains $share) { continue }
          $shareDetail = net share $share | Out-String
          if ($shareDetail -match "Everyone") {
              $vulnerableFound = $true
              break
          }
      }
      
      if ($vulnerableFound) {
          "EVERYONE_SHARE_PERMISSION_FOUND"
      } else {
          "EVERYONE_SHARE_PERMISSION_NOT_FOUND"
      }
    matchers:
      - type: word
        words:
          - "EVERYONE_SHARE_PERMISSION_FOUND"