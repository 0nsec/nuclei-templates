id: hotfix-check

info:
  name: Latest Hot Fix Check
  author: nukunga[SungHyunJeon]
  severity: medium
  description: |
    Verify that the latest Hot Fix has been applied. If the most recent Hot Fix was installed more than 45 days ago,
    the system may be missing critical security updates.
  impact: |
    Without the latest Hot Fixes, the system remains vulnerable to newly discovered security threats,
    potentially exposing it to exploits.
  remediation: |
    Apply the latest Hot Fixes via Windows Update, PMS Agent, or manual installation.
  tags: windows, patch-management, hotfix

self-contained: true

code:
  - pre-condition: |
      IsWindows();
    engine:
      - powershell
      - powershell.exe
    args:
      - -ExecutionPolicy
      - Bypass
    pattern: "*.ps1"
    source: |
      # Retrieve installed hotfixes using the built-in PowerShell cmdlet.
      $hotfixes = Get-HotFix -ErrorAction SilentlyContinue
      if (-not $hotfixes) {
          "HOTFIX_NOT_FOUND"
          exit
      }
      
      # Determine the most recent Hot Fix installation date.
      $latestHotfix = $hotfixes | Sort-Object InstalledOn -Descending | Select-Object -First 1
      
      # Calculate the number of days since the latest hotfix was installed.
      $daysSince = (New-TimeSpan -Start $latestHotfix.InstalledOn -End (Get-Date)).Days
      
      # Define threshold: if the latest hotfix is older than 45 days, consider it outdated.
      if ($daysSince -gt 45) {
          "HOTFIX_OUTDATED"
      } else {
          "HOTFIX_UP_TO_DATE"
      }
    matchers:
      - type: word
        words:
          - "HOTFIX_OUTDATED"