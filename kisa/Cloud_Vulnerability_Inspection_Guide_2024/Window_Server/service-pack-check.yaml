id: service-pack-check

info:
  name: Latest Service Pack Check
  author: nukunga[SungHyunJeon]
  severity: medium
  description: |
    Verify that the system is updated with the latest security patches or service packs. Keeping the system updated
    helps protect against known vulnerabilities.
  impact: |
    Failure to apply the latest service packs or updates can leave the system exposed to exploits and security breaches.
  remediation: |
    Apply the latest service packs or build updates:
      - For Windows Server 2012: Refer to https://support.microsoft.com/ko-kr/help/4009470
      - For Windows Server 2016: Refer to https://support.microsoft.com/ko-kr/help/4043454
      - For Windows Server 2019: Refer to https://support.microsoft.com/ko-kr/help/4581839
  tags: windows, service-pack, security, patch-management

self-contained: true

code:
  - pre-condition: |
      IsWindows();
    engine:
      - powershell
      - powershell.exe
    args:
      - -ExecutionPolicy
      - Bypass
    pattern: "*.ps1"
    source: |
      # Retrieve operating system details.
      $os = Get-CimInstance -ClassName Win32_OperatingSystem
      $caption = $os.Caption
      $servicePack = $os.ServicePackMajorVersion
      
      # For Windows Server 2012, a service pack should be installed.
      if ($caption -match "2012") {
          if ($servicePack -gt 0) {
              "SERVICE_PACK_COMPLIANT"
          } else {
              "SERVICE_PACK_VULNERABLE"
          }
      }
      # For Windows Server 2016, 2019, or 2022, service packs are generally not applicable; assume compliance.
      elseif ($caption -match "2016" -or $caption -match "2019" -or $caption -match "2022") {
          "SERVICE_PACK_COMPLIANT"
      }
      else {
          # For other versions, check if a service pack is installed.
          if ($servicePack -gt 0) {
              "SERVICE_PACK_COMPLIANT"
          } else {
              "SERVICE_PACK_VULNERABLE"
          }
      }
    matchers:
      - type: word
        words:
          - "SERVICE_PACK_VULNERABLE"
# digest: 490a00463044022067653c97bbe17bfc3bfd3ec9e18cb08a5172db43041078c6816aa02bd8502712022026b5941bc8490116e87e0f8aeea1f0f8ab63e06885f935c927db0f01d1a25379:3bd7ba8113bb8138bfd3703bfad1917a