id: ftp-directory-permission-check

info:
  name: FTP Directory Access Permission Check
  author: nukunga[SungHyunJeon]
  severity: medium
  description: |
    Verify that the FTP home directory does not grant access permissions to the "Everyone" group.
    If the "Everyone" group is present, it could allow unauthorized users to modify or tamper with files.
  impact: |
    Granting "Everyone" access to the FTP home directory can lead to information disclosure, file tampering, or unauthorized modifications.
  remediation: |
    Remove the "Everyone" group from the FTP home directory permissions via:
    - IIS Manager: Check the FTP site's home directory settings.
    - File Explorer: Right-click the directory, open "Properties" â†’ "Security" tab, and remove the "Everyone" group.
  tags: windows, ftp, iis, security

self-contained: true

code:
  - pre-condition: |
      IsWindows();
    engine:
      - powershell
      - powershell.exe
    args:
      - -ExecutionPolicy
      - Bypass
    pattern: "*.ps1"
    source: |
      # Define the FTP home directory path (adjust if necessary)
      $ftpHome = "C:\inetpub\ftproot"
      if (!(Test-Path $ftpHome)) {
          "FTP_HOME_DIRECTORY_NOT_FOUND"
          exit
      }
      
      # Retrieve the ACL for the FTP home directory
      $acl = Get-Acl $ftpHome
      
      $vulnerable = $false
      
      foreach ($ace in $acl.Access) {
          if ($ace.IdentityReference.ToString() -like "*Everyone*") {
              $vulnerable = $true
              break
          }
      }
      
      if ($vulnerable) {
          "FTP_HOME_DIRECTORY_EVERYONE_FOUND"
      } else {
          "FTP_HOME_DIRECTORY_NO_EVERYONE"
      }
    matchers:
      - type: word
        words:
          - "FTP_HOME_DIRECTORY_EVERYONE_FOUND"
# digest: 4a0a0047304502204a5dd81e97e46e697a3952693115d617d08caac77104776b4a6b03397c95ff0b022100bdceb76f684092f83d6910378c46d3c6f985c70be8958b46b0a0fa7d5885f1ba:3bd7ba8113bb8138bfd3703bfad1917a