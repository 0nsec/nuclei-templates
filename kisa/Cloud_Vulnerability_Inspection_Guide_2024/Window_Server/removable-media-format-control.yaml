id: removable-media-format-control

info:
  name: Removable Media Format and Eject Control Check
  author: nukunga[SungHyunJeon]
  severity: medium
  description: |
    Verify that the removable media format and eject control policy is restricted to Administrators only.
    This is determined by checking the 'allocatedasd' registry value in
    HKLM:\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon.
    A value of "0" indicates that only Administrators are allowed to format or eject removable media.
  impact: |
    If the policy permits users beyond Administrators (e.g., Power Users or Interactive Users),
    unauthorized users could gain control over removable media operations, potentially leading to data exfiltration or unauthorized file modifications.
  remediation: |
    Set the 'allocatedasd' value to "0" in the registry key:
    HKLM:\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon.
    For Windows Server 2022, if the value is absent (the default), create it and set it to "0".
  tags: windows, removable-media, registry, security

self-contained: true

code:
  - pre-condition: |
      IsWindows();
    engine:
      - powershell
      - powershell.exe
    args:
      - -ExecutionPolicy
      - Bypass
    pattern: "*.ps1"
    source: |
      # Define the registry path for Winlogon settings.
      $regPath = "HKLM:\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon"
      
      # Try to retrieve the 'allocatedasd' value.
      $regValueObj = Get-ItemProperty -Path $regPath -Name allocatedasd -ErrorAction SilentlyContinue
      $allocatedasd = $regValueObj.allocatedasd
      
      # Get OS information to determine if it's Windows Server 2022.
      $os = Get-CimInstance -ClassName Win32_OperatingSystem
      $isWin2022 = $os.Caption -like "*2022*"
      
      # Determine compliance:
      # - If the value is not set:
      #     - For Windows Server 2022, absence is the default and considered compliant.
      #     - For other systems, report as not configured.
      # - If the value exists, it must equal 0.
      if ($null -eq $allocatedasd) {
          if ($isWin2022) {
              "REMOVABLE_MEDIA_POLICY_COMPLIANT"
          } else {
              "REMOVABLE_MEDIA_POLICY_NOT_CONFIGURED"
          }
      } elseif ($allocatedasd -eq 0) {
          "REMOVABLE_MEDIA_POLICY_COMPLIANT"
      } else {
          "REMOVABLE_MEDIA_POLICY_VULNERABLE"
      }
    matchers:
      - type: word
        words:
          - "REMOVABLE_MEDIA_POLICY_VULNERABLE"