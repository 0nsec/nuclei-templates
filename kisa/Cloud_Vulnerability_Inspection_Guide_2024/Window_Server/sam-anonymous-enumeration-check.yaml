id: sam-anonymous-enumeration-check

info:
  name: SAM Account and Shares Anonymous Enumeration Disallowed Check
  author: nukunga[SungHyunJeon]
  severity: medium
  description: |
    Verify that anonymous enumeration of SAM accounts and network shares is disabled by ensuring that both
    'restrictanonymous' and 'restrictanonymoussam' registry values are set to 1. This prevents unauthorized
    users from enumerating account names and network shares, which could facilitate password guessing or social engineering attacks.
  impact: |
    If these settings are not enforced, attackers may enumerate domain accounts, computer accounts, groups, and shared resources,
    increasing the risk of targeted attacks.
  remediation: |
    Configure the following registry settings:
      - Set HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Lsa\restrictanonymous to 1.
      - Set HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Lsa\restrictanonymoussam to 1.
  tags: windows, sam, security, registry

self-contained: true

code:
  - pre-condition: |
      IsWindows();
    engine:
      - powershell
      - powershell.exe
    args:
      - -ExecutionPolicy
      - Bypass
    pattern: "*.ps1"
    source: |
      $regPath = "HKLM:\SYSTEM\CurrentControlSet\Control\Lsa"
      $restrictAnonymous = (Get-ItemProperty -Path $regPath -Name restrictanonymous -ErrorAction SilentlyContinue).restrictanonymous
      $restrictAnonymousSAM = (Get-ItemProperty -Path $regPath -Name restrictanonymoussam -ErrorAction SilentlyContinue).restrictanonymoussam
      if (($restrictAnonymous -eq 1) -and ($restrictAnonymousSAM -eq 1)) {
          "SAM_ANONYMOUS_ENUMERATION_DISABLED"
      } else {
          "SAM_ANONYMOUS_ENUMERATION_ENABLED"
      }
    matchers:
      - type: word
        words:
          - "SAM_ANONYMOUS_ENUMERATION_ENABLED"