id: crash-on-audit-fail

info:
  name: Shutdown on Audit Failure Check
  author: nukunga[SungHyunJeon]
  severity: medium
  description: |
    Verify that the "Shutdown on Audit Failure" policy is disabled.
    The policy should be set to "4,0" so that the system does not shut down immediately if it is unable to log security audits.
    If the policy is set to "4,1", the system will shut down, potentially leading to a denial-of-service condition.
  impact: |
    If the policy is enabled (set to "4,1"), the system may shut down unexpectedly when audit logs cannot be recorded,
    disrupting services and potentially causing data loss.
  remediation: |
    Disable the policy by configuring the CrashOnAuditFail value to "4,0". This can be done by:
      - Using the Registry Editor to navigate to:
        HKLM:\Software\Microsoft\Windows\CurrentVersion\policies\system
        and setting CrashOnAuditFail to "4,0".
      - Adjusting the local security policy ("Audit: Shutdown the system if unable to log security audits") to Disabled.
  tags: account-management,code,windows-audit,kisa,policy

self-contained: true

code:
  - pre-condition: |
      IsWindows();
    engine:
      - powershell
      - powershell.exe
    args:
      - -ExecutionPolicy
      - Bypass
    pattern: "*.ps1"
    source: |
      $cfgPath = "C:\cfg.txt"
      secedit /export /cfg $cfgPath | Out-Null
      $cfg = Get-Content $cfgPath | Out-String
      if ($cfg -match "CrashOnAuditFail\s*=\s*(\S+)") {
          $value = $Matches[1].Trim()
          if ($value -eq "4,1") {
              "CRASH_ON_AUDIT_FAIL_ENABLED"
          } else {
              "CRASH_ON_AUDIT_FAIL_DISABLED"
          }
      } else {
          "CRASH_ON_AUDIT_FAIL_NOT_FOUND"
      }

    matchers:
      - type: word
        words:
          - "CRASH_ON_AUDIT_FAIL_ENABLED"