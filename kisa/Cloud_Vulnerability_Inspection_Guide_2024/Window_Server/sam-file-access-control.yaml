id: sam-file-access-control

info:
  name: SAM File Access Control Check
  author: nukunga[SungHyunJeon]
  severity: medium
  description: |
    Verify that the SAM file (%SystemRoot%\system32\config\SAM) is secured such that only the Administrators and SYSTEM groups have full access.
    If permissions for any other users or groups are found, it indicates a potential security risk.
  impact: |
    If accounts or groups other than Administrators and SYSTEM have access to the SAM file, attackers may exploit this to access sensitive password data,
    increasing the risk of password attacks.
  remediation: |
    Remove any permissions granted to accounts or groups other than the Administrators and SYSTEM groups. This can be done by running:
    > cacls %systemroot%\system32\config\SAM /remove:g [UserOrGroup]
    or by modifying the permissions via File Explorer.
  tags: windows, sam, security, account-management

self-contained: true

code:
  - pre-condition: |
      IsWindows();
    engine:
      - powershell
      - powershell.exe
    args:
      - -ExecutionPolicy
      - Bypass
    pattern: "*.ps1"
    source: |
      $samPath = "$env:SystemRoot\system32\config\SAM"
      if (-Not (Test-Path $samPath)) {
          "SAM_FILE_NOT_FOUND"
          exit
      }
      
      # Retrieve the ACL for the SAM file
      $acl = Get-Acl $samPath
      
      # Define allowed identities (variations may exist)
      $allowed = @("BUILTIN\Administrators", "Administrators", "NT AUTHORITY\SYSTEM", "SYSTEM")
      $vulnerable = $false
      
      foreach ($ace in $acl.Access) {
          $account = $ace.IdentityReference.ToString()
          if ($allowed -notcontains $account) {
              $vulnerable = $true
              break
          }
      }
      
      if ($vulnerable) {
          "SAM_ACCESS_VULNERABLE"
      } else {
          "SAM_ACCESS_COMPLIANT"
      }
    matchers:
      - type: word
        words:
          - "SAM_ACCESS_VULNERABLE"
# digest: 490a0046304402200e855bba1db7860f2911ea7a231ab63fd72017943d39c47b78cbc42a0e3dde8702205b4940d1432848b7a7d7a7dc2d1bd85e58e8fc684341200187510dd5cc467045:3bd7ba8113bb8138bfd3703bfad1917a