id: password-never-expires

info:
  name: Password Expiry Setting Check
  author: nukunga[SungHyunJeon]
  severity: medium
  description: Verify that the "password never expires" setting is disabled for all active accounts to ensure password expiration policies are effective.
  impact: |
    If the "password never expires" setting is enabled, even with a maximum password age configured, the policy will not be enforced,
    increasing the risk of credential compromise.
  remediation: |
    Disable the "password never expires" setting via:
    > wmic useraccount where name="USERNAME" set passwordexpires=true
    or through Local Security Policy.
  tags: windows, account-management, password-policy

self-contained: true

code:
  - pre-condition: |
      IsWindows();
    engine:
      - powershell
      - powershell.exe
    args:
      - -ExecutionPolicy
      - Bypass
    pattern: "*.ps1"
    source: |
      # Check all local, active user accounts for the password expiry setting
      $users = Get-WmiObject -Class Win32_UserAccount -Filter "LocalAccount=True and Disabled=False"
      $vulnerable = $users | Where-Object { $_.PasswordExpires -eq $false }
      if ($vulnerable) {
          "PASSWORD_NEVER_EXPIRES_ENABLED"
      } else {
          "PASSWORD_NEVER_EXPIRES_DISABLED"
      }
    matchers:
      - type: word
        words:
          - "PASSWORD_NEVER_EXPIRES_ENABLED"
# digest: 4a0a004730450220686b1a6cd0849a20cdafdc42af4d7e68ec4269d8fedc5a25b6930fa2bf845dae02210095b218ced18847b6495bb2ebf85e5b5319118ed4907eefff91fe840a2dca5a43:3bd7ba8113bb8138bfd3703bfad1917a