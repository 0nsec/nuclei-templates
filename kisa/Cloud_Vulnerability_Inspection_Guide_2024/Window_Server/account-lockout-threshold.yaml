id: account-lockout-threshold

info:
  name: Account Lockout Threshold Check
  author: nukunga[SungHyunJeon]
  severity: medium
  description: Verify account lockout threshold is set to 5 or fewer attempts to prevent brute-force attacks.
  impact: |
    Missing lockout threshold allows unlimited password guessing attempts, increasing risk of account compromise.
  remediation: |
    Configure lockout threshold via:
    > net accounts /lockoutthreshold:5
    or through Local Security Policy settings.
  tags: windows,account-management,code,windows-audit,kisa

self-contained: true

code:
  - pre-condition: |
      IsWindows();
    engine:
      - powershell
      - powershell.exe

    args:
      - -ExecutionPolicy
      - Bypass

    pattern: "*.ps1"
    source: |
      $netAccountsOutput = net accounts
      $thresholdLine = $netAccountsOutput | Where-Object { $_ -match "Lockout threshold:" }
      if ($thresholdLine) {
          # "Lockout threshold:"
          $matches = [regex]::Match($thresholdLine, "Lockout threshold:\s+(\S+)")
          if ($matches.Success) {
              $value = $matches.Groups[1].Value.Trim()
              if ($value -eq "0" -or $value -eq "Never") {
                  Write-Output "ACCOUNT_LOCKOUT_THRESHOLD_NOT_SET"
              }
              elseif ([int]$value -gt 5) {
                  Write-Output "ACCOUNT_LOCKOUT_THRESHOLD_EXCEEDS_MAX"
              }
              else {
                  Write-Output "ACCOUNT_LOCKOUT_THRESHOLD_OK"
              }
          }
          else {
              Write-Output "ACCOUNT_LOCKOUT_THRESHOLD_NOT_FOUND"
          }
      }
      else {
          Write-Output "ACCOUNT_LOCKOUT_THRESHOLD_NOT_FOUND"
      }

    matchers:
      - type: word
        words:
          - "ACCOUNT_LOCKOUT_THRESHOLD_NOT_SET"
          - "ACCOUNT_LOCKOUT_THRESHOLD_EXCEEDS_MAX"
        condition: or