id: adcs-certificate

info:
  name: AD CS Web Enrollment and HTTP Interfaces - Detection
  author: pastaga,defte,atomiczsec
  severity: info
  description: |
    Detects the presence of Active Directory Certificate Services (AD CS) Web Enrollment interfaces, including /certenroll/ and /certsrv, which allow users and computers to request certificates through web pages.
  metadata:
    verified: true
    shodan-query: html:"/certenroll"
  tags: ad,adcs,exposure,files,web-enrollment

http:
  - method: GET
    path:
      - "{{BaseURL}}/certenroll/"
      - "{{BaseURL}}/CertEnroll/"
      - "{{BaseURL}}/certsrv"
    host-redirects: true

matchers-condition: or
matchers:
  - type: dsl
    name: certenroll
    dsl:
      - contains(body, ".crl") || contains(body, ".crt")
      - contains(body, "CertEnroll") || contains(body, "certenroll")
      - status_code == 200
    condition: and
  - type: dsl
    name: certsrv
    dsl:
      - status_code == 200 && contains(body, "locMSCertSrv")
  - type: word
    name: certsrv_phrases
    words:
      - "Microsoft Active Directory Certificate Services"
      - "Web Enrollment"
    part: body
    condition: or
