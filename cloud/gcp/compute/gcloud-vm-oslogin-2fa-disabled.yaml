id: gcloud-vm-oslogin-2fa-disabled

info:
  name: OS Login with 2FA Authentication Not Enabled for VM Instances
  author: princechaddha
  severity: high
  description: |
    Ensure that the OS Login feature enabled at the virtual machine instance level is configured with Two-Factor Authentication (2FA) in order to help protect the access to your Google Cloud VM instances. Two-Factor Authentication (also known as Multi-Factor Authentication - MFA) provides an additional layer of security on top of the existing credentials.
  impact: |
    Without 2FA enabled for OS Login, VM instances are more vulnerable to unauthorized access through compromised credentials.
  remediation: |
    Enable OS Login with 2FA authentication for all VM instances by setting the "enable-oslogin-2fa" metadata key to "TRUE".
  reference:
    - https://cloud.google.com/compute/docs/oslogin/set-up-oslogin
  tags: cloud,devops,gcp,gcloud,compute,security,2fa,gcp-cloud-config

flow: |
  code(1)
  for(let projectId of iterate(template.projectIds)){
    set("projectId", projectId)
    code(2)
    for(let instance of iterate(template.instances)){
      instance = JSON.parse(instance)
      set("instanceName", instance.name)
      set("zone", instance.zone)
      code(3)
    }
  }

self-contained: true

code:
  - engine:
      - sh
      - bash
    source: |
      gcloud projects list --format="json(projectId)"

    extractors:
      - type: json
        name: projectIds
        internal: true
        json:
          - '.[].projectId'

  - engine:
      - sh
      - bash
    source: |
      gcloud compute instances list --project $projectId --format="json[](name,zone.basename())"

    extractors:
      - type: json
        name: instances
        internal: true
        json:
          - '.[]'

  - engine:
      - sh
      - bash
    source: |
      gcloud compute instances describe $instanceName --zone $zone --project $projectId --format="json(metadata.items)" | jq '.items[]? | select(.key=="enable-oslogin-2fa") | .value // "null"'

    matchers:
      - type: word
        words:
          - "FALSE"
          - "null"
        condition: or

    extractors:
      - type: dsl
        dsl:
          - '"OS Login with 2FA authentication is not enabled for VM instance " + instanceName + " in zone " + zone + " of project " + projectId' 
# digest: 4a0a004730450220364f666eb4864a851ab60cf5baaff34e6be2e0d850b4e84d858b8c4f94b85a07022100dd6ceb745138c139a0cbd7c7bceaefe7c64b9cdbf36769aaccb68d50f79bef91:46366314a226e6e09736af12eeb345c0