id: gcloud-iam-ownership-monitoring-disabled

info:
  name: Enable Project Ownership Assignments Monitoring
  author: princechaddha
  severity: medium
  description: |
    Ensure that each Google Cloud Platform (GCP) project has configured an alerting policy to monitor IAM ownership assignments. The alerting policy should trigger notifications whenever the "Owner" role is granted or removed for any IAM member.
  impact: |
    Without monitoring IAM ownership assignments, unauthorized role changes may go undetected, leading to potential security risks and non-compliance with organizational policies.
  remediation: |
    Configure a GCP alerting policy to monitor IAM ownership assignments by using a logs-based metric with the required filter. Ensure the alerting policy is enabled and properly configured with valid notification channels.
  reference:
    - https://cloud.google.com/logging/docs/export/configure_export_v2
    - https://cloud.google.com/monitoring/alerts/concepts-indepth
  tags: cloud,devops,gcp,gcloud,iam,gcp-cloud-config

flow: |
  code(1)
  for(let projectId of iterate(template.projectIds)){
    set("projectId", projectId)
    code(2)
    for(let loggingMetric of iterate(template.loggingMetrics)){
      set("loggingMetric", loggingMetric)
      code(3)
      for(let alertPolicy of iterate(template.alertPolicies)){
        set("alertPolicy", alertPolicy)
        code(4)
      }
    }
  }

self-contained: true

code:
  - engine:
      - sh
      - bash
    source: |
      gcloud projects list --format="json(projectId)"

    extractors:
      - type: json
        name: projectIds
        internal: true
        json:
          - '.[].projectId'

  - engine:
      - sh
      - bash
    source: |
      gcloud logging metrics list --project=$projectId --format="json(name)"

    extractors:
      - type: json
        name: loggingMetrics
        internal: true
        json:
          - '.[].name'

  - engine:
      - sh
      - bash
    source: |
      gcloud logging metrics describe $loggingMetric --project=$projectId --format="json(filter)"

    matchers:
      - type: regex
        regex:
          - 'resource\.type=global AND \(protoPayload\.serviceName=cloudresourcemanager\.googleapis\.com\) AND \(ProjectOwnership OR projectOwnerInvitee\) OR \(protoPayload\.serviceData\.policyDelta\.bindingDeltas\.action=REMOVE AND protoPayload\.serviceData\.policyDelta\.bindingDeltas\.role=roles/owner\) OR \(protoPayload\.serviceData\.policyDelta\.bindingDeltas\.action=ADD AND protoPayload\.serviceData\.policyDelta\.bindingDeltas\.role=roles/owner\)'

    extractors:
      - type: dsl
        dsl:
          - '"Metric filter valid for monitoring ownership changes in project: " + projectId + ", metric: " + loggingMetric'

  - engine:
      - sh
      - bash
    source: |
      gcloud alpha monitoring policies list --project=$projectId --format="json(name)"

    extractors:
      - type: json
        name: alertPolicies
        internal: true
        json:
          - '.[].name'

  - engine:
      - sh
      - bash
    source: |
      gcloud alpha monitoring policies describe $alertPolicy --project=$projectId --format="json(enabled,conditions,notificationChannels)"

    matchers:
      - type: word
        words:
          - '"enabled": false'
          - '"notificationChannels": []'
        condition: or

    extractors:
      - type: dsl
        dsl:
          - '"Non-compliant alerting policy detected: " + alertPolicy + " in project: " + projectId'