id: azure-keyvault-resource-lock-check
info:
  name: Azure KeyVault Resource Lock Not Enabled
  author: princechaddha
  severity: high
  description: |
    Ensure that all your mission critical Azure cloud resources have resource locks enabled so that certain users are not able to delete or modify these resources in order to help prevent accidental and malicious changes or deletion.
  impact: |
    Not having resource locks on mission-critical resources can lead to accidental or malicious modifications and deletions, potentially compromising the security and stability of the application.
  remediation: |
    Apply resource locks to all critical Azure resources, particularly Key Vaults. Use either the "ReadOnly" or "CanNotDelete" lock levels to prevent unwanted changes or deletions.
  reference:
    - https://docs.microsoft.com/en-us/azure/azure-resource-manager/management/lock-resources
  tags: cloud,devops,azure,microsoft,keyvault,azure-cloud-config

flow: |
  code(1);
  for (let keyVaultData of iterate(template.keyvaultdata)) {
    keyVaultData = JSON.parse(keyVaultData)
    set("resource", keyVaultData.id)
    code(2)
  }

self-contained: true
code:
  - engine:
      - sh
      - bash
    source: |
      az keyvault list --query '[*].id' --output json

    extractors:
      - type: json
        name: keyvaultdata
        internal: true
        json:
          - '.[]'

  - engine:
      - sh
      - bash
    source: |
      az lock list --resource $resource --query '[*].{"name":name,"level":level}'

    matchers:
      - type: word
        words:
          - '"CanNotDelete"'
          - '"ReadOnly"'

      - type: word
        words:
          - '[]'

    extractors:
      - type: dsl
        dsl:
          - 'resource + " does not have the required resource lock level"'

# digest: 490a0046304402204437c761f42b3808cf8e0c42ad3a475b0007f9f6ab01a62b9e66618f496c56d8022053587c2d5bafbc5f86aa568a44d3a95a57c3833b954a572ac5824f64c7ed8575:922c64590222798bb761d5b6d8e72950