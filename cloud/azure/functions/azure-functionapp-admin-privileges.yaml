id: azure-functionapp-admin-privileges
info:
  name: Azure Functions with Admin Privileges
  author: princechaddha
  severity: medium
  description: |
    Ensure that your functions managed with Microsoft Azure Function App don't have privileged administrative permissions in order to promote the Principle of Least Privilege (POLP) and provide your functions the minimal amount of access required to perform their tasks.
  impact: |
    Having administrative privileges can expose Azure Function Apps to unnecessary risks and potential security breaches, violating the principle of least privilege.
  remediation: |
    Review and restrict the roles assigned to function apps to ensure they only have permissions necessary for their operation. Modify the roles through Azure portal or Azure CLI.
  reference:
    - https://docs.microsoft.com/en-us/azure/azure-functions/functions-reference
  tags: cloud,devops,azure,microsoft,functionapp,azure-cloud-config

flow: |
  code(1);
  for (let functionName of iterate(template.functionNames)) {
    AppData = JSON.parse(functionName);  
    set("functionName", AppData.name)
    set("resourceGroup", AppData.resourceGroup)
    code(2);
    for (let assignee of iterate(template.assignees)) {
      set("assignee", assignee)
      code(3)
    }
  }

self-contained: true
code:
  - engine:
      - sh
      - bash
    source: |
      az functionapp list --query '[*].{name:name, resourceGroup:resourceGroup}' --output json

    extractors:
      - type: json
        name: functionNames
        internal: true
        json:
          - '.[]'

  - engine:
      - sh
      - bash
    source: |
      az functionapp show --name $functionName --resource-group $resourceGroup --query 'identity.userAssignedIdentities' --output json

    extractors:
      - type: json
        name: assignees
        internal: true
        json:
          - '.[].principalId'

  - engine:
      - sh
      - bash
    source: |
      az role assignment list --assignee $assignee --all --output json

    matchers:
      - type: word
        words:
          - 'Owner'
          - 'Contributor'
          - 'User Access Administrator'
          - 'Role Based Access Control Administrator'

    extractors:
      - type: json
        name: roleAssignments
        internal: true
        json:
          - '.[].roleDefinitionName'

      - type: dsl
        dsl:
          - 'functionName + " has admin privileges with role " + roleAssignment + " in resource group " + resourceGroup'
# digest: 4a0a0047304502206c53befacf7870a0640e4b057b36a6405779335abc7cf916b95f2c7e8b55af400221009b81df9c8b06377aef96689f3cb4df77ed008857c1f83e93ea8cd1b1fe4c0ae6:366f2a24c8eb519f6968bd8801c08ebe