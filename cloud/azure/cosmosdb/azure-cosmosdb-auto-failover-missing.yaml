id: azure-cosmosdb-auto-failover-missing
info:
  name: Azure Cosmos DB Automatic Failover Not Enabled
  author: princechaddha
  severity: high
  description: |
    Ensure that your Microsoft Azure Cosmos DB accounts are using the Automatic Failover feature in order to enable resource replication and fault tolerance at the account level. Automatic failover allows Azure Cosmos DB to failover to the Azure cloud region with the highest failover priority when the source region becomes unavailable, without any additional action from the application or the user. The Cosmos DB account must have two or more regions configured in order to enable the feature.
  impact: |
    Not enabling Automatic Failover for Cosmos DB accounts may lead to increased downtime and data availability issues during regional outages.
  remediation: |
    Enable the Automatic Failover feature on your Azure Cosmos DB accounts to ensure high availability and fault tolerance across multiple regions.
  reference:
    - https://docs.microsoft.com/en-us/azure/cosmos-db/high-availability
  tags: cloud,devops,azure,microsoft,cosmosdb,azure-cloud-config

flow: |
  code(1);
  for (let CosmosDBData of iterate(template.cosmosDBAccounts)) {
    set("id", CosmosDBData);
    code(2);
  }

self-contained: true
code:
  - engine:
      - sh
      - bash
    source: |
      az cosmosdb list --query '[*].id' --output json

    extractors:
      - type: json
        name: cosmosDBAccounts
        internal: true
        json:
          - '.[]'

  - engine:
      - sh
      - bash
    source: |
      az cosmosdb show --ids $id --query 'enableAutomaticFailover' --output json

    matchers:
      - type: word
        words:
          - "false"

    extractors:
      - type: dsl
        dsl:
          - 'id + " does not have Automatic Failover enabled"'
# digest: 4a0a0047304502205367242b3c8ba5438df47c0aa9d716b779d483cd689f977437e006d944dca88202210090d70e274320921b287b4dbe74f3e3203d0726a4cd5da7afb3235ba00b92a696:366f2a24c8eb519f6968bd8801c08ebe