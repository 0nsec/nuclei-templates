id: azure-storage-min-tls-version
info:
  name: Azure Storage Minimum TLS Version Not Set to TLS1_2
  author: princechaddha
  severity: medium
  description: |
    Ensure that all your Microsoft Azure Storage accounts are using the latest available version of the TLS protocol in order to enhance the security of the connection between your storage accounts and their clients/applications, and comply with the industry standards.
  impact: |
    Not using the latest version of the TLS protocol may expose data transfers to or from Azure Storage accounts to higher security risks.
  remediation: |
    Configure all Azure Storage accounts to use TLS version 1.2 as the minimum required version for connections to ensure compliance with industry standards and enhanced security.
  reference:
    - https://docs.microsoft.com/en-us/azure/storage/common/storage-security-guide
  tags: cloud,devops,azure,microsoft,storage,azure-cloud-config

flow: |
  code(1);
  for (let AccountData of iterate(template.accountList)) {
    AccountData = JSON.parse(AccountData);
    set("name", AccountData.Name);
    code(2);
  }

self-contained: true
code:
  - engine:
      - sh
      - bash
    source: |
      az storage account list --query '[*].{"Name":name}'

    extractors:
      - type: json
        name: accountList
        internal: true
        json:
          - '.[]'

  - engine:
      - sh
      - bash
    source: |
      az storage account show --name "$name" --query 'minimumTlsVersion'

    matchers-condition: and
    matchers:
      - type: word
        words:
          - 'TLS'

      - type: word
        words:
          - 'TLS1_2'
        negative: true

    extractors:
      - type: dsl
        dsl:
          - 'name + " is not using TLS version 1.2"'
# digest: 4a0a0047304502207de5ffbd22b8130c0e8162da25c26bee5c19c6ea57d51509afe8d300c80e14a00221009048f184f11b6b3c54fc276f4c906f554da22d21124903e2259d1676ecafc719:366f2a24c8eb519f6968bd8801c08ebe