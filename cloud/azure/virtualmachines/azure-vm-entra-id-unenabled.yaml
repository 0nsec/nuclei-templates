id: azure-vm-entra-id-unenabled
info:
  name: Azure VM Microsoft Entra ID Authentication Not Enabled
  author: princechaddha
  severity: medium
  description: |
    Ensure that your Microsoft Azure virtual machines (VMs) are configured to use Microsoft Entra ID credentials for secure SSH/RDP access. Once enabled, you can use your corporate Microsoft Entra ID credentials to log in to your virtual machines, enforce Multi-Factor Authentication (MFA), or enable access via RBAC roles.
  impact: |
    Not configuring VMs with Microsoft Entra ID authentication could expose them to unauthorized access and security breaches.
  remediation: |
    Ensure the Microsoft Entra ID authentication extensions, "AADLoginForWindows" or "AADLoginForLinux", are installed and enabled on your Azure VMs for secure access management.
  reference:
    - https://docs.microsoft.com/en-us/azure/active-directory/develop/
  tags: cloud,devops,azure,microsoft,entra-id,azure-cloud-config

flow: |
  code(1);
  for (let VmData of iterate(template.vmList)) {
    VmData = JSON.parse(VmData);
    set("name", VmData.name);
    set("resourceGroup", VmData.resourceGroup);
    code(2);
  }

self-contained: true
code:
  - engine:
      - sh
      - bash
    source: |
      az vm list --output json --query '[*].{"name":name,"resourceGroup":resourceGroup}'

    extractors:
      - type: json
        name: vmList
        internal: true
        json:
          - '.[]'

  - engine:
      - sh
      - bash
    source: |
      az vm extension list --vm-name "$name" --resource-group "$resourceGroup" --query '[*].name'

    matchers-condition: and
    matchers:
      - type: word
        words:
          - 'AADLoginForWindows'
          - 'AADLoginForLinux'

    extractors:
      - type: dsl
        dsl:
          - 'name + " in " + resourceGroup + " does not have Microsoft Entra ID authentication enabled"'
# digest: 4a0a00473045022100d1537aa6f6c034bf81989e678dff759f546ec97c27bc3e544526f2c3ef8678d00220534d01cefb75b4a51a2e869e5d0e16803a3231b3edde7539ca3748801a563568:366f2a24c8eb519f6968bd8801c08ebe