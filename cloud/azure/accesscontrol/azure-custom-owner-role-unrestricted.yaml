id: azure-custom-owner-role-unrestricted
info:
  name: Azure Custom Owner Role Available
  author: princechaddha
  severity: medium
  description: |
    Ensure that there are no custom subscription owner roles available in your Azure account in order to adhere to cloud security best practices and implement the principle of least privilege - the practice of providing every user the minimal amount of access required to perform its tasks.
  impact: |
    Having custom owner roles can provide excessive permissions that exceed the requirements of the users, potentially leading to security vulnerabilities.
  remediation: |
    Remove any custom owner roles or modify their permissions to align with the principle of least privilege, ensuring users have only the necessary access rights to perform their duties.
  reference:
    - https://docs.microsoft.com/en-us/azure/role-based-access-control/custom-roles
  tags: cloud,devops,azure,microsoft,role-management,azure-cloud-config

flow: |
  code(1);
  for (let RoleData of iterate(template.roleList)) {
    set("roleName", RoleData);
    code(2);
  }

self-contained: true
code:
  - engine:
      - sh
      - bash
    source: |
      az role definition list --custom-role-only true --query '[].{roleName:roleName}' --output json

    extractors:
      - type: json
        name: roleList
        internal: true
        json:
          - '.[]'

  - engine:
      - sh
      - bash
    source: |
      az role definition list --name "$roleName" --output json --query '[?(assignableScopes == `/` || assignableScopes == `/subscriptions/` && actions == `*`)].roleName'

    matchers-condition: and
    matchers:
      - type: word
        words:
          - 'roleName'

    extractors:
      - type: dsl
        dsl:
          - 'roleName + " is a custom owner role with excessive permissions"'
# digest: 4a0a00473045022001bb4c6ef38e95037225aa537fed449d23d4d2ff5171a6479c022d5b0bb4e9e0022100eecefea61b04e3a4dcad1300a4b985c6c728c3e0ac5e7a24cead54bbaf850d48:366f2a24c8eb519f6968bd8801c08ebe