id: azure-apim-public-access-disabled
info:
  name: Azure API Management Public Network Access Disabled with Private Endpoint
  author: princechaddha
  severity: high
  description: |
    Azure API Management services configured with a private endpoint should not be publicly accessible to enhance security by ensuring that the API service instance is only accessible from within your private network, over Azure Private Link, limiting exposure to potential external threats and unauthorized access.
  impact: |
    If public network access is enabled for Azure API Management services with a private endpoint, it may expose sensitive APIs to external threats and unauthorized access, potentially leading to data breaches and other security vulnerabilities.
  remediation: |
    Disable public network access for Azure API Management services that are configured with a private endpoint to ensure they are only accessible via Azure Private Link within the private network.
  reference:
    - https://docs.microsoft.com/en-us/azure/api-management/api-management-howto-protect-backend-with-private-link
  tags: cloud,devops,azure,microsoft,api-management,azure-cloud-config

flow: |
  code(1);
  for (let ServiceData of iterate(template.serviceList)) {
    ServiceData = JSON.parse(ServiceData);
    set("name", ServiceData.name);
    set("resourceGroup", ServiceData.resourceGroup);
    code(2);
  }

self-contained: true
code:
  - engine:
      - sh
      - bash
    source: |
      az apim list --output json --query '[*].{name:name, resourceGroup:resourceGroup}'

    extractors:
      - type: json
        name: serviceList
        internal: true
        json:
          - '.[]'

  - engine:
      - sh
      - bash
    source: |
      az apim show --name "$name" --resource-group "$resourceGroup" --query 'publicNetworkAccess'

    matchers-condition: and
    matchers:
      - type: word
        words:
          - 'Enabled'

    extractors:
      - type: dsl
        dsl:
          - 'name + " in resource group " + resourceGroup + " has public network access enabled, which should be disabled."'

# digest: 4a0a0047304502203627d111b8d992b0378aa3f14fa209d5c44247a8d4c7c8a4e9647f7f4e04de2d0221009b18dac63aee7a78a709a399a55f2191d358aaa28b7f20b62791038ccf1d91d2:922c64590222798bb761d5b6d8e72950