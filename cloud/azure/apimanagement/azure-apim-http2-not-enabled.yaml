id: azure-apim-http2-not-enabled
info:
  name: Azure API Management HTTP/2 Support Not Enabled
  author: princechaddha
  severity: medium
  description: |
    Ensure that your Azure API Management API gateways are configured to use HTTP/2 to increase API performance on the client-side. HTTP/2 is designed to reduce the impact of latency and connection load on servers by using features like full request and response multiplexing, minimizing protocol overhead, and supporting request prioritization and server push.
  impact: |
    Not enabling HTTP/2 in Azure API Management gateways can result in less efficient communication, increased latency, and higher load on the API gateways, which can degrade the performance of the API services.
  remediation: |
    Enable HTTP/2 support in Azure API Management gateways by setting the 'Microsoft.WindowsAzure.ApiManagement.Gateway.Protocols.Server.Http2' property to 'true'.
  reference:
    - https://docs.microsoft.com/en-us/azure/api-management/api-management-howto-http2
  tags: cloud,devops,azure,microsoft,api-management,azure-cloud-config

flow: |
  code(1);
  for (let APIData of iterate(template.apiList)) {
    APIData = JSON.parse(APIData);
    set("name", APIData.name);
    set("resourceGroup", APIData.resourceGroup);
    code(2);
  }

self-contained: true
code:
  - engine:
      - sh
      - bash
    source: |
      az apim list --output json --query '[*].{name:name, resourceGroup:resourceGroup}'

    extractors:
      - type: json
        name: apiList
        internal: true
        json:
          - '.[]'

  - engine:
      - sh
      - bash
    source: |
      az apim show --name "$name" --resource-group "$resourceGroup" --output json --query 'customProperties'

    matchers-condition: and
    matchers:
      - type: word
        words:
          - '"Microsoft.WindowsAzure.ApiManagement.Gateway.Protocols.Server.Http2": "False"'

    extractors:
      - type: dsl
        dsl:
          - 'name + " in resource group " + resourceGroup + " does not have HTTP/2 enabled"'
# digest: 4a0a0047304502207a885822902f83eeacf692208f301fb6ad194b47f2fb255ff586c38840af83f0022100d4e2e50bd19062d9e2858f7cc1fc7a4cf95cfe8014cd65f8360e99296c16fcc2:922c64590222798bb761d5b6d8e72950