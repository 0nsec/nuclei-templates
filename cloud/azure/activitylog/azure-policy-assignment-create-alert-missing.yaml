id: azure-policy-assignment-create-alert-missing
info:
  name: Azure Policy Assignment Create Alert Not Configured
  author: princechaddha
  severity: high
  description: |
    Ensure that an Azure activity log alert is used to detect "Create Policy Assignment" events within your Microsoft Azure cloud account. Activity log alerts get activated when a new activity log event that matches the condition specified in the alert occurs. In this case, the condition used is 'Whenever the Policy Activity Log "Create policy assignment (policyAssignments)" has "any" level, with "any" status and event is initiated by "any"'.
  impact: |
    Not having a specific alert for policy assignment creation events can lead to missing critical activities that could affect the security and compliance of your Azure environment.
  remediation: |
    Configure an Azure activity log alert for "Create Policy Assignment" events to ensure compliance and enhance security monitoring.
  reference:
    - https://docs.microsoft.com/en-us/azure/azure-monitor/platform/alerts-activity-log
  tags: cloud,devops,azure,microsoft,azure-monitor,azure-cloud-config

flow: |
  code(1);
  for (let AlertData of iterate(template.alertList)) {
    set("id", AlertData);
    code(2);
  }

self-contained: true
code:
  - engine:
      - sh
      - bash
    source: |
      az monitor activity-log alert list --output json --query '[?(enabled==`true`)].id'

    extractors:
      - type: json
        name: alertList
        internal: true
        json:
          - '.[]'

  - engine:
      - sh
      - bash
    source: |
      az monitor activity-log alert show --ids "$id" --query 'condition'

    matchers:
      - type: word
        words:
          - "Microsoft.Authorization/policyAssignments/write"

    extractors:
      - type: dsl
        dsl:
          - 'id + " alert does not detect Create Policy Assignment events"'
# digest: 4a0a00473045022021ad983edfe84bb9ba7e327e9480df4687cd953a954538a6e8069a6697745872022100e6a69802b70cb3abb0beee9b8d9c8dd678fb0e4d16d131e1204d358a8baaae7d:366f2a24c8eb519f6968bd8801c08ebe