id: azure-mfa-not-enabled-privileged-users
info:
  name: Azure MFA Not Enabled for All Privileged Users
  author: princechaddha
  severity: high
  description: |
    Ensure that Multi-Factor Authentication (MFA) is enabled for all user credentials that have write access to the cloud resources within your Microsoft Azure account. Multi-Factor Authentication is a simple, yet efficient method of verifying your Azure user identity by requiring an authentication code generated by a virtual or hardware device, also known as passcode, used in addition to your usual access credentials such as user name and password.
  impact: |
    Without MFA enabled for privileged users, there is an increased risk of unauthorized access which can lead to potential breaches and significant impact on cloud resources and data security.
  remediation: |
    Configure Multi-Factor Authentication for all privileged Azure user accounts to enhance security measures and prevent unauthorized access.
  reference:
    - https://docs.microsoft.com/en-us/azure/active-directory/authentication/concept-mfa-howitworks
  tags: cloud,devops,azure,microsoft,multi-factor-authentication,azure-cloud-config

flow: |
  code(1);
  for (let User of iterate(template.userList)) {
    set("userPrincipalName", User);
    code(2);
  }

self-contained: true
code:
  - engine:
      - sh
      - bash
    source: |
      az ad user list --query '[].{userPrincipalName:userPrincipalName}' --output json

    extractors:
      - type: json
        name: userList
        internal: true
        json:
          - '.[].userPrincipalName'

  - engine:
      - sh
      - bash
    source: |
      az role assignment list --include-classic-administrators true --assignee "$userPrincipalName" --query '[].{roleDefinitionName:roleDefinitionName}' --output json

    matchers-condition: and
    matchers:
      - type: word
        words:
          - 'Owner'
          - 'Contributor'
          - 'Administrator'

    extractors:
      - type: dsl
        dsl:
          - 'userPrincipalName + " is a privileged user without MFA enabled"'
# digest: 4b0a00483046022100b3ee2f2ad05990e471943e9d6862062e3e3c5302819095905cb5138abce8a2a7022100ea6300584d2fb3f3371ba15c51e95747ed9d2952dadb629bd6f8a95aa209820e:366f2a24c8eb519f6968bd8801c08ebe